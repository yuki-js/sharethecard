name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

# Cancel in-progress runs for the same workflow on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    strategy:
      matrix:
        node-version: [18.x, 20.x, 24.x]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Authenticate with GitHub Packages
        run: |
          echo "@aokiapp:registry=https://npm.pkg.github.com/" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

      - name: Install dependencies
        run: npm ci

      - name: Type checking
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format -- --check

      - name: Build all packages
        run: npm run build

      - name: Run unit tests
        run: npm run test:unit

      - name: Run integration tests
        run: npm run test:integration

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Run Bash integration tests
        run: npm run test:bash
        if: matrix.node-version == '20.x'

      - name: Generate coverage report
        run: npm run test -- --coverage
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: matrix.node-version == '20.x'
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  security-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Authenticate with GitHub Packages
        run: |
          echo "@aokiapp:registry=https://npm.pkg.github.com/" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

  build-and-package:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Authenticate with GitHub Packages
        run: |
          echo "@aokiapp:registry=https://npm.pkg.github.com/" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

      - name: Install dependencies
        run: npm ci

      - name: Build all packages
        run: npm run build

      - name: Verify builds
        run: |
          test -f packages/controller/dist/cli/main.js || (echo "Controller build failed" && exit 1)
          test -f packages/cardhost/dist/index.js || (echo "Cardhost build failed" && exit 1)
          test -f packages/router/dist/server.js || (echo "Router build failed" && exit 1)
          test -f packages/shared/dist/index.js || (echo "Shared build failed" && exit 1)

      - name: Package with dependencies
        run: |
          mkdir -p dist-release
          
          # Controller
          mkdir -p dist-release/controller
          cp -r packages/controller/dist dist-release/controller/
          cp packages/controller/package.json dist-release/controller/
          cp -r packages/shared/dist dist-release/controller/shared-dist
          cd dist-release/controller && npm install --production --omit=dev && cd ../..
          
          # Router
          mkdir -p dist-release/router
          cp -r packages/router/dist dist-release/router/
          cp packages/router/package.json dist-release/router/
          cp -r packages/shared/dist dist-release/router/shared-dist
          cd dist-release/router && npm install --production --omit=dev && cd ../..
          
          # Cardhost
          mkdir -p dist-release/cardhost
          cp -r packages/cardhost/dist dist-release/cardhost/
          cp packages/cardhost/package.json dist-release/cardhost/
          cp -r packages/shared/dist dist-release/cardhost/shared-dist
          cd dist-release/cardhost && npm install --production --omit=dev && cd ../..

      - name: Create archives
        run: |
          cd dist-release
          tar -czf controller.tar.gz controller/
          tar -czf router.tar.gz router/
          tar -czf cardhost.tar.gz cardhost/
          cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: |
            dist-release/controller.tar.gz
            dist-release/router.tar.gz
            dist-release/cardhost.tar.gz
          retention-days: 7

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-and-test, security-audit, build-and-package]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-packages
          path: release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## Release ${{ github.ref_name }}

            Built and tested on Node.js 18.x, 20.x, and 24.x

            ### Pre-built Packages

            - `controller.tar.gz` - Controller CLI
            - `router.tar.gz` - Router Server
            - `cardhost.tar.gz` - Cardhost Service

            ### Installation

            Requires Node.js 18+ to run.

            ```bash
            # Extract package
            tar -xzf controller.tar.gz
            cd controller

            # Run directly
            node dist/cli/main.js --help
            ```

            ### Quick Start

            ```bash
            # Start router
            tar -xzf router.tar.gz && cd router
            node dist/server.js &
            cd ..

            # Start cardhost with mock platform
            tar -xzf cardhost.tar.gz && cd cardhost
            node dist/runtime/main.js --mock &
            cd ..

            # Send APDU command
            cd controller
            node dist/cli/main.js send --apdu 00A4040000
            ```
          draft: false
          prerelease: false
          files: |
            release/controller.tar.gz
            release/router.tar.gz
            release/cardhost.tar.gz
